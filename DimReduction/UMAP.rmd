---
title: "rare_disease_ewce: UMAP" 
author: "Brian M. Schilder"
date: "Most recent update:<br> `r Sys.Date()`"
output: 
  rmarkdown::html_document: 
    theme: spacelab
    highlight: zenburn 
    code_folding: show 
    toc: true 
    toc_float: true
    smooth_scroll: true
    number_sections: false 
    self_contained: true 
editor_options: 
  chunk_output_type: inline
---
 
```{r setup, include=T, message=F, warning=F} 
root.dir <- here::here()
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  root.dir = root.dir
  fig.height = 12,
  fig.width = 10
)  
knitr::opts_knit$set(root.dir = root.dir, dpi = 300)   

library(dplyr)
library(ggplot2)
library(Matrix)
set.seed(2020)
source("tfidf.R")
source("utils.R")

color_dict <- c(phenotype="purple", 
                celltype="turquoise")
```


# Human Phenotype Ontology 

## Data
  
```{r} 
HPO <- data.table::fread("https://ci.monarchinitiative.org/view/hpo/job/hpo.annotations/lastSuccessfulBuild/artifact/rare-diseases/util/annotation/phenotype_to_genes.txt", nThread = 10) 

colnames(HPO) <- gsub("-|[ ]","_",stringr::str_split(gsub("#Format: ","",colnames(HPO)[1]),"<tab>")[[1]])
HPO <- HPO %>% dplyr::mutate(HPOid=HPO_id, HPO_id=gsub("[:]",".",HPO_id))
```

### Genes / term

```{r}
gene_counts <- HPO %>%  
  dplyr::group_by(HPO_id, HPO_label) %>% 
  dplyr::summarise(genes=dplyr::n_distinct(entrez_gene_symbol)) %>%
  dplyr::arrange(desc(genes))
print(gene_counts)

dim(subset(gene_counts, genes==1))
select_ids <- subset(gene_counts, genes>=4)$HPO_id
print(paste(length(select_ids),"/",n_distinct(gene_counts$HPO_id), "selected."))

hist(gene_counts$genes, breaks = 100)  
```

### Create matrix

```{r}
HPO$val <- 1
mat <- data.table::dcast.data.table(subset(HPO, HPO_id %in% select_ids), 
                                    formula = entrez_gene_symbol ~ HPO_id,
                                    value.var = "val",
                                    fill = 0, 
                                    fun.aggregate = max) %>%
  data.frame() %>%
  tibble::column_to_rownames(var = "entrez_gene_symbol") %>%
   data.frame()
mat <- as(as.matrix(mat),"sparseMatrix") 


## Specificity matrix
library(Matrix)
normalised_meanExp = t(t(mat)*(1/Matrix::colSums(mat)))
mat_spec = normalised_meanExp/(apply(normalised_meanExp,1,sum)+0.000000000001)
```

## Metadata 


### Ancestors  

Use [ontologyIndex](https://cran.r-project.org/web/packages/ontologyIndex/vignettes/intro-to-ontologyX.html) to annotation terms further.

```{r}
library(ontologyIndex)
data("hpo")

if(!exists("ancest_df")){ 
  ancest_1 <- lapply(unique(HPO$HPOid), function(x){
    # print(x)
    tryCatch(expr = {
      terms <- get_term_property(ontology=hpo, property="ancestors", term=x, as_names=T)
      return(terms[2]) 
      }, 
    error = function(e)return(NULL))
  }) %>% `names<-`(unique(HPO$HPOid))
  ancest_2 <- lapply(unique(HPO$HPOid), function(x){
    # print(x)
    tryCatch(expr = {
      terms <- get_term_property(ontology=hpo, property="ancestors", term=x, as_names=T)
      return(terms[3]) 
      }, 
    error = function(e)return(NULL))
  }) %>% `names<-`(unique(HPO$HPOid))
  
  
  ancest_df <- rbind(data.frame(ancestor_label=unlist(ancest_1), ancestor_lvl=1), 
                     data.frame(ancestor_label=unlist(ancest_2),  ancestor_lvl=2)) %>% 
    tibble::rownames_to_column(var = "id") %>%
    tidyr::separate(col = "id", sep = "[.]", into=c("HPOid", "ancestor_id"))  %>%
    data.table::data.table() %>%
    data.table::melt.data.table(id.vars = c("HPOid","ancestor_lvl"), 
                                measure.vars = c("ancestor_id","ancestor_label")) %>%
    dplyr::mutate(variable=paste0(variable,ancestor_lvl)) %>%
    data.table::dcast.data.table(formula = HPOid ~ variable, value.var = "value")
  ancest_df
  
  n_distinct(ancest_df$HPOid)  
}

```

### Merge metadata

Create metadata table for each term. 

```{r} 
# parents <- data.table::fread("TermsToUse.csv")
meta <- unique(HPO[,c("HPOid","HPO_id","HPO_label")]) %>% 
  # merge(parents, by.x = "HPO_label", by.y = "HPOterm") %>%
  merge(ancest_df, by="HPOid", all.x = T) %>%
  merge(gene_counts[,c("HPO_id","genes")], by="HPO_id")
meta
 

data.table::fwrite(meta %>%dplyr::select(-HPO_id) %>% dplyr::arrange(genes), "DimReduction/HPO_metadata.csv")
```
 





# Tabula Muris

```{r}
library(EWCE)
try({data("CTD_meta")})
# CTD_meta <- readxl::read_excel("~/projects/model_celltype_conservation/CTD_metadata.xlsx")
ctd_tm <- readRDS(url(subset(CTD_meta, dataset=="TabulaMuris")$url)) 
```

### Binarize matrix  

```{r}
mat_tm <- binarize_ctd(ctd_tm, level=2, 
                       top_quantiles = 2,
                       # top_genes = 100,
                       replace_nonzeros = T)
dim(mat_tm) 
```

# LaManno2020

```{r} 
ctd_lamanno <- readRDS(url(subset(CTD_meta, dataset=="LaManno2020")$url)) 
```

### Binarize matrix  

```{r}
mat_lamanno <- binarize_ctd(ctd_lamanno, level=4, 
                            top_quantiles = 4,
                            replace_nonzeros = T)
dim(mat_lamanno) 
```


# Descartes 

```{r}
ctd_descartes <- readRDS(url(subset(CTD_meta, dataset=="descartes_SampledData")$url)) 

```

### Binarize matrix  

```{r}
mat_desc <- binarize_ctd(ctd_descartes, 
                         level=2, 
                         top_genes = 100,
                         replace_nonzeros = T)
dim(mat_desc)
```



# Merge data 

## Merge CTD 


```{r} 
library(Matrix.utils)

mat_ctd <- Matrix.utils::merge.Matrix(mat_tm, mat_lamanno, 
                                      by.x = row.names(mat_tm), 
                                      by.y = row.names(mat_lamanno), 
                                      all.x=F, all.y=F)  
# mat_ctd <- mat_tm
 
meta_ctd <- data.frame(id=colnames(mat_ctd)) %>%
   tidyr::separate(col = "id", remove = F, sep = "[.]", 
                  into = c("species","dataset","celltype"), 
                  extra = "merge") %>%
  data.table::data.table()
```

Merge the HPO and CTD matrices. 

```{r}
MAT <-  
  Matrix.utils::merge.Matrix(mat, mat_ctd, 
                             by.x = row.names(mat), 
                             by.y = row.names(mat_ctd), 
                             all.x=F, all.y=F)  
dim(MAT)
# MAT[is.na(MAT)] <- 0
# MAT[MAT!=0] <-1



merged_meta <- data.table::data.table(id=colnames(MAT)) %>% 
  merge(meta, by.x="id", by.y = "HPO_id", all.x = T) %>%
  merge(meta_ctd, by="id", all.x = T) %>%
  dplyr::mutate(type=factor(ifelse(is.na(HPOid),"celltype","phenotype"), 
                            levels = c("phenotype","celltype"), ordered = T)) %>%
  dplyr::mutate(label=ifelse(is.na(HPO_label),celltype,HPO_label), 
                # genes=ifelse(is.na(genes), n_genes[id], genes),
                species=ifelse(type=="phenotype","human",species),
                dataset=ifelse(type=="phenotype","HPO",dataset)) 

```

## Count genes 

```{r} 
n_genes <- sort(DelayedArray::colSums(MAT, na.rm = T), decreasing = T)
# hist(n_genes, breaks = 50)
gene_df <- data.frame(genes=n_genes[n_genes>0]) %>% 
  tibble::rownames_to_column("id") %>%
  merge(merged_meta %>%dplyr::select(-genes), by="id") %>%
  data.table::data.table()

ggplot(gene_df, aes(fill=dataset, x=genes)) +
  geom_histogram(bins = 50) +
  facet_grid(facets=dataset~., scales = "free") +
  theme_bw()

merged_meta$genes <- n_genes[merged_meta$id]
```


# UMAP

## Run UMAP 

- Computing Hamming distances should be theoretically better for binary data. But sometimes euclidean produces better inter-group mixing. 

The python implementation of UMAP has [more distance options](https://umap-learn.readthedocs.io/en/latest/parameters.html).

```{r}
umap_res <- uwot::umap(X = t(as.matrix(MAT)), 
                       n_components = 2, 
                       ret_extra = c("model","nn","fgraph"),  
                       # metric = "hamming",
                       verbose = T) 
```

## Plot 

```{r}
embed <- umap_res$embedding %>%
  `colnames<-`(paste0("UMAP_",1:ncol(umap_res$embedding))) %>%
  data.table::data.table() %>%
  dplyr::mutate(id=colnames(MAT)) %>%
  merge(merged_meta, by="id", all.x = T)  


gg_umap <- ggplot(embed, aes(x=UMAP_1, y=UMAP_2, 
                             color=dataset, shape=type, 
                             label=label, size=genes,
                             ancestor_label1=ancestor_label1,
                             ancestor_label2=ancestor_label2)) +
  geom_point(alpha=.5) +
  # scale_color_manual(values = color_dict) + 
  scale_color_manual(values = unname(pals::alphabet())) +
  theme_bw() 
plotly::ggplotly(gg_umap)
```


# Cluster 

```{r}
library(Seurat)

seurat <- Seurat::CreateSeuratObject(counts = MAT, 
                                     meta.data = data.frame(embed, row.names = embed$id))
#### Select variable features ####
# Better to include more (perhaps all?) genes
seurat <- Seurat::FindVariableFeatures(seurat)
                                       # nfeatures=nrow(seurat))
gg_var <- Seurat::VariableFeaturePlot(seurat)
# Seurat::VariableFeatures(seurat) <- row.names(seurat)

seurat <- Seurat::NormalizeData(seurat)
seurat <- Seurat::ScaleData(seurat,  vars.to.regress = c("type","dataset")) # genes

seurat <- Seurat::RunPCA(seurat) # slot="count"
# Seurat::ElbowPlot(seurat, ndims = 50)
seurat <- Seurat::FindNeighbors(seurat)
seurat <- Seurat::RunUMAP(seurat, dims=1:50) #metric="hamming")
seurat <- Seurat::FindClusters(seurat, reduction="umap")

Seurat::DimPlot(seurat, group.by = c("seurat_clusters","type"))
```

## Term enrichment 

## TF-IDF

```{r}
seurat <- seurat_tfidf(seurat, 
                        label_var = "label", 
                        cluster_var = "seurat_clusters", 
                        force_new = T)
saveRDS(seurat, "DimReduction/seurat.rds")
```

### word2vec   

Follows[ tutorial here](http://www.bnosac.be/index.php/blog/100-word2vec-in-R). 

```{r, eval=F}
library(word2vec) 

model <- word2vec(x = setNames(seurat@meta.data$id, 
                               seurat@meta.data$seurat_clusters), 
                  dim =15,iter =20)
embedding <-as.matrix(model)

library(uwot)
viz <- uwot::umap(embedding,n_neighbors =15,n_threads =10)
rownames(viz) <-rownames(embedding)
df  <- viz %>% `colnames<-`(c("x","y")) %>% data.frame() %>%tibble::rownames_to_column("word")


ggplot(df,aes(x =x,y =y,label =word)) +
  geom_point() + 
  ggrepel::geom_text_repel() + 
  theme_void() + 
  labs(title ="word2vec")
```


```{r}
seurat$ancestor_label1[seurat$type=="celltype"] <- "Cell-type"
seurat$ancestor_label1[is.na(seurat$ancestor_label1)] <- "Other phenotype"

gg_tfidf <- umap_tfidf(seurat = seurat,
                       size_var = "genes",
                       shape="type",
                       # color_var = "dataset", 
                       color_var="ancestor_label1",
                       dataset="dataset",
                       shape_var="type",
                       species="species",
                       Label="label", 
                       ancestor_label1="ancestor_label1",
                       density_palette = "Blues",
                       show_plot=T)
plotly::ggplotly(gg_tfidf)

ggsave("DimReduction/UMAP.tfidf.pdf", gg_tfidf, height = 8, width = 13, dpi = 300)
```
  
# Session info  

<details>

```{r Session Info, attr.output='style="max-height: 200px;"'}
utils::sessionInfo()
```

</details>


